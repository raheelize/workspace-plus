{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Seat Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ensure seat elements are draggable but not selecting text */
    .seat-admin { touch-action: none; user-select: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-bold">Admin Seat Map â€” Drag seats to position</h1>
      <div>
        <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Save Positions</button>
        <a href="{% url 'seats:index' %}" class="ml-3 text-sm text-blue-600">View public map</a>
      </div>
    </div>

    <p class="text-sm text-gray-600 mb-4">Drag a seat, drop it at desired location, then press Save. Coordinates are in pixels relative to the map container top-left.</p>

    <!-- map container -->
    <div id="map" class="relative bg-white border rounded-lg shadow h-[700px]">
      {% for seat in seats %}
        <div
          class="seat-admin absolute w-12 h-12 rounded-lg flex items-center justify-center text-white font-semibold cursor-grab shadow-md"
          data-id="{{ seat.id }}"
          style="left: {{ seat.x|default:50 }}px; top: {{ seat.y|default:50 }}px; background: {% if seat.is_reserved and seat.user == request.user %} #2563eb {% elif seat.is_reserved %} #ef4444 {% else %} #10b981 {% endif %};"
          title="Code: {{ seat.code }} (id: {{ seat.id }})"
        >
          {{ seat.code }}
        </div>
      {% endfor %}
    </div>

    <div id="status" class="mt-4 text-sm text-gray-700"></div>
  </div>

<script>
(function(){
  const map = document.getElementById('map');
  const saveBtn = document.getElementById('save-btn');
  const status = document.getElementById('status');

  let dragging = null;
  let offset = {x:0,y:0};

  // Setup pointer events for each seat element
  map.querySelectorAll('.seat-admin').forEach(el => {
    el.addEventListener('pointerdown', (ev) => {
      dragging = el;
      el.setPointerCapture(ev.pointerId);
      const rect = el.getBoundingClientRect();
      const parentRect = map.getBoundingClientRect();
      offset.x = ev.clientX - rect.left;
      offset.y = ev.clientY - rect.top;
      el.style.cursor = 'grabbing';
    });

    el.addEventListener('pointermove', (ev) => {
      if (!dragging) return;
      if (ev.pressure === 0 && ev.pointerType === 'mouse') {
        // pointermove may fire with pressure 0 when no button; ignore
      }
      const parentRect = map.getBoundingClientRect();
      let x = ev.clientX - parentRect.left - offset.x;
      let y = ev.clientY - parentRect.top - offset.y;

      // clamp inside container
      x = Math.max(0, Math.min(parentRect.width - el.offsetWidth, x));
      y = Math.max(0, Math.min(parentRect.height - el.offsetHeight, y));

      el.style.left = x + 'px';
      el.style.top = y + 'px';
    });

    el.addEventListener('pointerup', (ev) => {
      if (!dragging) return;
      dragging.releasePointerCapture(ev.pointerId);
      dragging.style.cursor = 'grab';
      dragging = null;
      // show current coordinates briefly
      const id = el.dataset.id;
      const x = parseInt(el.style.left);
      const y = parseInt(el.style.top);
      status.textContent = `Seat ${el.textContent} (id ${id}) at x:${x}, y:${y} (not saved)`;
    });

    // prevent default double click selection
    el.addEventListener('dblclick', (ev) => ev.preventDefault());
  });

  saveBtn.addEventListener('click', async () => {
    const payload = [];
    map.querySelectorAll('.seat-admin').forEach(el => {
      payload.push({
        id: el.dataset.id,
        x: Math.round(parseFloat(el.style.left) || 0),
        y: Math.round(parseFloat(el.style.top) || 0)
      });
    });

    status.textContent = 'Saving...';
    try {
      const res = await fetch("{% url 'seats:save_positions' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (data.ok) {
        status.textContent = `Saved ${data.updated} seats.`;
      } else {
        status.textContent = 'Save failed.';
      }
    } catch (err) {
      status.textContent = 'Error saving positions: ' + err;
    }
  });

  // helper to get csrf cookie
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

})();
</script>
</body>
</html>
