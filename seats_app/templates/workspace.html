{% extends 'base.html' %}
{% block title %}Book your seat | Workspace+{% endblock %}

{% block content %}
<div class="bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-2xl p-4 md:p-6 border border-gray-700/50 max-w-7xl mx-auto">

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 pb-4 border-b border-gray-700/50 mb-6">
        
        <div class="flex items-center gap-4 flex-wrap text-sm">
            
            <h2 class="text-lg font-bold text-gray-300 hidden sm:block">Location:</h2>

            <div class="flex items-center">
                <form method="GET" class="flex items-center gap-2">
                    <label class="text-gray-400 font-medium whitespace-nowrap">Workspace</label>
                    <select name="workspace"
                        onchange="this.form.submit()"
                        class="bg-gray-700/50 text-gray-100 border border-gray-600 rounded-lg px-2 py-1 focus:ring-1 focus:ring-blue-500 text-sm focus:outline-none min-w-[120px]">
                        {% for ws in workspaces %}
                        <option value="{{ ws.id }}" {% if ws.id == workspace.id %}selected{% endif %}>
                            {{ ws.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if space %}
                    <input type="hidden" name="space" value="{{ space.id }}">
                    {% endif %}
                </form>
            </div>

            <span class="text-gray-600 hidden sm:block">/</span>

            <div class="flex items-center">
                <form method="GET" class="flex items-center gap-2">
                    <label class="text-gray-400 font-medium whitespace-nowrap">Space</label>
                    <input type="hidden" name="workspace" value="{{ workspace.id }}">
                    <select name="space"
                        onchange="this.form.submit()"
                        class="bg-gray-700/50 text-gray-100 border border-gray-600 rounded-lg px-2 py-1 focus:ring-1 focus:ring-blue-500 text-sm focus:outline-none min-w-[120px]">
                        {% for sp in spaces %}
                        <option value="{{ sp.id }}" {% if sp.id == space.id %}selected{% endif %}>
                            {{ sp.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        <div class="flex-shrink-0 w-full md:w-auto mt-2 md:mt-0">
            {% if user_reservation %}
            <div class="flex items-center gap-3 bg-gray-700/70 rounded-full pl-3 pr-1 py-1 shadow-md border border-blue-500/50 text-gray-200 text-sm">
                <span class="font-medium">Your Seat:</span>
                <span class="font-extrabold text-white font-mono tracking-widest">{{ user_reservation.seat.code }}</span>
                <button id="cancel-reservation-btn"
                        class="inline-flex items-center justify-center w-7 h-7 bg-red-600 hover:bg-red-500 text-white rounded-full transition-all duration-200"
                        title="Cancel Reservation">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            {% else %}
            <p class="text-gray-400 text-xs md:text-sm">
                <span class="font-semibold text-blue-400">8:30 AM - 9:15 AM</span> Booking Window Expires at <span class="font-semibold text-blue-400">06:00 PM</span>
            </p>
            {% endif %}
        </div>
    </div>
    
    {% if seats %}
    <div id="seat-map-container" 
        class="flex justify-center items-center w-full overflow-x-auto bg-gray-900/40 rounded-xl shadow-inner p-6">
        <div id="seat-map-wrapper" class="relative inline-block min-w-max">
            <div id="seat-map" class="relative rounded-xl mx-auto" style="transform-origin: top center;">
                {% for seat in seats %}
                    <div
                        class="absolute flex flex-col items-center justify-center rounded-xl font-bold transition-all duration-300 ease-out seat-item shadow-lg
                            {% if not seat.is_active %}
                                bg-gray-500 cursor-not-allowed opacity-50 text-gray-800
                            {% elif seat.is_reserved and seat.user == request.user %}
                                bg-gradient-to-br from-blue-500 to-purple-600 text-white ring-4 ring-blue-400/50 hover:shadow-xl
                            {% elif seat.is_reserved %}
                                bg-gradient-to-br from-red-500 to-red-700 text-white cursor-not-allowed hover:shadow-xl
                            {% else %}
                                bg-gradient-to-br from-green-400 to-emerald-500 text-white cursor-pointer hover:scale-[1.1] hover:shadow-2xl hover:from-green-500 hover:to-emerald-600 active:scale-[0.95]
                            {% endif %}"
                        data-seat-id="{{ seat.id }}"
                        data-x="{{ seat.x }}"
                        data-y="{{ seat.y }}"
                        title="Seat {{ seat.code }}"
                        style="width: 50px; height: 50px;"
                    >
                        <svg class="w-5 h-5 text-current" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 10h12v2H4v-2zm0-4h12v2H4V6zm2 8h2v4H6v-4zm6 0h2v4h-2v-4z"/>
                        </svg>
                        <span class="seat-label text-xs font-semibold -mt-0.5">{{ seat.code }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <p class="text-center text-gray-400 p-6 bg-gray-900/50 rounded-xl border border-gray-700">
        No seats found for this space.
    </p>
    {% endif %}

    <div class="mt-6 flex flex-col md:flex-row items-center justify-between gap-4">
        
        <div class="flex flex-wrap justify-center md:justify-start gap-x-4 gap-y-2 text-gray-300 flex-1">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full"></div>
                <span class="text-xs">Available</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-gradient-to-br from-red-500 to-red-700 rounded-full"></div>
                <span class="text-xs">Reserved</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full"></div>
                <span class="text-xs">Your Seat</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-gradient-to-br from-gray-500 to-gray-600 rounded-full"></div>
                <span class="text-xs">Unavailable</span>
            </div>
        </div>

        <div class="flex-shrink-0">
            <form method="POST" id="booking-form">
                {% csrf_token %}
                <input type="hidden" name="seat_id" id="selected-seat-id">
                <button 
                    type="submit"
                    id="book-btn"
                    class="min-w-[200px] bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold text-base py-2.5 px-6 rounded-lg shadow-lg transition-all duration-300
                            disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:shadow-none disabled:text-gray-400"
                    disabled
                >
                    <span id="btn-text">Select a Seat</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- 🧠 Seat Map JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const seatMap = document.getElementById('seat-map');
  const bookBtn = document.getElementById('book-btn');
  const seatInput = document.getElementById('selected-seat-id');
  const selectedSeatDisplay = document.getElementById('selected-seat-display');
  const btnText = document.getElementById('btn-text');
  let selectedSeat = null;

  const seats = Array.from(document.querySelectorAll('[data-seat-id]'));
  if (seats.length === 0) return;

  // Find seat coordinate bounds
  const coords = seats.map(seat => ({
    x: parseFloat(seat.dataset.x),
    y: parseFloat(seat.dataset.y)
  }));

  const minX = Math.min(...coords.map(c => c.x));
  const maxX = Math.max(...coords.map(c => c.x)) + 44;
  const minY = Math.min(...coords.map(c => c.y));
  const maxY = Math.max(...coords.map(c => c.y)) + 44;

  const seatWidth = maxX - minX;
  const seatHeight = maxY - minY;

  seatMap.style.width = `${seatWidth}px`;
  seatMap.style.height = `${seatHeight}px`;

  // Reposition seats relative to minX/minY
  seats.forEach(seat => {
    const x = parseFloat(seat.dataset.x) - minX;
    const y = parseFloat(seat.dataset.y) - minY;
    seat.style.left = `${x}px`;
    seat.style.top = `${y}px`;
  });

  // 🔄 Responsive scaling
  const resizeSeatMap = () => {
    const containerWidth = document.getElementById('seat-map-container').clientWidth;
    const scale = Math.min(containerWidth / seatWidth, 1);
    seatMap.style.transform = `scale(${scale})`;
  };

  resizeSeatMap();
  window.addEventListener('resize', () => {
    clearTimeout(window._resizeTimer);
    window._resizeTimer = setTimeout(resizeSeatMap, 200);
  });

  // 🎯 Seat selection
  seatMap.addEventListener('click', e => {
    const seat = e.target.closest('[data-seat-id]');
    if (!seat || seat.classList.contains('cursor-not-allowed')) return;

    if (selectedSeat) {
      selectedSeat.classList.remove('ring-4', 'ring-blue-400', 'seat-selected', 'scale-110');
      selectedSeat.classList.remove('from-blue-500', 'to-indigo-600');
      selectedSeat.classList.add('from-green-400', 'to-emerald-500');
    }

    selectedSeat = seat;
    seat.classList.remove('from-green-400', 'to-emerald-500');
    seat.classList.add('from-blue-500', 'to-indigo-600', 'ring-4', 'ring-blue-400', 'seat-selected', 'scale-110');
    
    const seatCode = seat.querySelector('.seat-label').textContent;
    bookBtn.disabled = false;
    seatInput.value = seat.dataset.seatId;
    // selectedSeatDisplay.textContent = `Seat ${seatCode} selected`;
    btnText.textContent = `Confirm Seat ${seatCode}`;
  });
});



function resetUI() {
    const seatDisplay = document.getElementById("selected-seat-display");
    if (seatDisplay) seatDisplay.textContent = "";

    const seatInput = document.getElementById("selected-seat-id");
    if (seatInput) seatInput.value = "";

    const bookBtn = document.getElementById("book-btn");
    if (bookBtn) bookBtn.disabled = true;

    document.querySelectorAll(".seat-item").forEach(el => {
        el.classList.remove(
            "seat-selected", "ring-4", "ring-blue-400", 
            "scale-110", "from-blue-500", "to-indigo-600", 
            "from-red-400", "to-red-600"
        );
        el.classList.add("from-green-400", "to-emerald-500");
    });
}


// 🎟️ Book Seat
document.getElementById("booking-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const seatId = document.getElementById("selected-seat-id").value;
  const bookBtn = document.getElementById("book-btn");

  if (!seatId) return showToast("⚠️ Please select a seat first!", "warning");
  bookBtn.disabled = true;

  try {
    const res = await fetch("{% url 'book_seat_api' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
      body: JSON.stringify({ seat_id: seatId })
    });

    const data = await res.json();
    if (res.ok) {
      showToast(`✅ Seat booked successfully!`, "success");
      resetUI();
      setTimeout(() => location.reload(), 1000);
    } else showToast(data.error || "Booking failed.", "error");
  } catch {
    showToast("Network error — try again.", "error");
  } finally {
    bookBtn.disabled = false;
  }
});

// ❌ Cancel Reservation
document.getElementById("cancel-reservation-btn")?.addEventListener("click", async () => {
  try {
    const res = await fetch("{% url 'cancel_reservation_api' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
    });

    const data = await res.json();
    if (res.ok) {
      showToast("Reservation cancelled.", "success");
      resetUI();
      setTimeout(() => location.reload(), 1000);
    } else showToast(data.error || "Cancel failed.", "error");
  } catch {
    showToast("Error cancelling reservation.", "error");
  }
});

// ✨ Small animation
const style = document.createElement("style");
style.textContent = `
@keyframes slide-down {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-slide-down {
  animation: slide-down 0.3s ease-out;
}
`;
document.head.appendChild(style);


</script>
{% endblock %}
